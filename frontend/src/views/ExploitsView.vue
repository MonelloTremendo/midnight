<template>
  <div
    class="container d-flex pb-2"
    style="flex-direction: column; height: calc(100vh - 58px - 4.5rem)"
  >
    <h1>Exploits</h1>
    <div class="container mt-3 m-0 p-0">
      <div class="row">
        <div class="col-11 pe-0">
          <button
            class="btn btn-success w-100"
            role="button"
            @click="addExploit"
          >
            <i class="bi-plus-lg"></i> Add Exploit
          </button>
        </div>
        <div class="col-1 ps-1">
          <button
            class="col-1 btn btn-success w-100"
            role="button"
            data-bs-target="#template-modal"
            data-bs-toggle="modal"
            @click="showTemplateModal"
          >
            <i class="bi bi-diagram-3-fill"></i>
          </button>
        </div>
      </div>
    </div>
    <div class="mt-3" style="flex: 0 1 auto; overflow-y: auto">
      <ExploitCard
        class="exploit"
        v-if="exploits.length != 0 && exploitsStats.length != 0"
        v-for="exploit in exploits"
        :prop-exploit="exploit"
        :prop-flags-count="exploitsStats.find((item) => item.id == exploit.id)"
        :prop-teams="teams"
        :prop-selected-teams="exploitsTeams[exploit.id]"
      />
    </div>
        <Modal
            prop-center
            prop-title="Templates" 
            prop-id="template-modal">
            <div v-for="(template, index) in templates" class="d-flex justify-content-between align-items-end mb-2">
                <div class="d-flex m-0 p-0 mt-1">
                    <textarea class="m-0 p-0" style="opacity: 0; width: 1px; height: 1px;"
                        @focus="$event.target.select()" ref="clone" readonly :value="template.source"></textarea>
                    <h5 class="text-start m-0 p-0">{{ template.name }}</h5>
                </div>
                <button class="btn btn-success" role="button" @click="() => copyToClipboard(index)">   
                    <i class="h6 bi-clipboard2-fill"></i>          
                </button>
            </div>
        </Modal>
  </div>
</template>

<style>
.exploit:not(:first-child) {
  margin-top: 1rem;
}
</style>

<script>
import * as _ from "lodash";
import { api } from "../utils";
import settings from "../settings.js";
import router from "../router";
import ExploitCard from "../components/ExploitCard.vue";
import Modal from "../components/Modal.vue";

export default {
  name: "Exploits",
  components: { ExploitCard, Modal },
  data() {
    return {
      templates: settings.templates,
      teams: [],
      exploits: [],
      exploitsTeams: {},
      exploitsStats: [],
      timer: null,
      websocket: null,
    };
  },
  methods: {
    async getExploitsData() {
      let exploits = await (await api.get("/exploits/")).json();
      let exploitState = await (await api.get("/exploits/state")).json();
      this.exploitsTeams = await (await api.get("/exploits/teams")).json();

      this.exploits = _.merge(
        _.keyBy(exploits, "id"),
        _.keyBy(exploitState, "id")
      );
    },
    async getTeamsData() {
      this.teams = await (await api.get("/teams/")).json();
    },
    async addExploit() {
      let id = await api.post("/exploits/", {
        name: "Service v0",
        source: "",
        threads: 16,
        timeout: 45,
        runperiod: 60,
      });
      id = parseInt(await id.text());
      console.log(id)
      router.push({ name: "exploit-edit", params: { id } });
    },
    async getExploitStatus() {
      let time = parseInt(Date.now() / 1000) - (parseInt(Date.now() / 1000) % 120);
      let res = await api.get(`/stats/flags/scripts/time/${time}`);
      this.exploitsStats = await res.json();
    },
    async copyToClipboard(index) {
      console.log(this.$refs.clone);
      this.$refs.clone[index].focus();
      document.execCommand("copy");
    },
  },
  async mounted() {
    await this.getExploitsData();
    await this.getTeamsData();
    await this.getExploitStatus();

    let url = new URL(settings.websocket_url, window.location.href);

    url.protocol = url.protocol.replace("http", "ws");

    this.websocket = new WebSocket(url.href);

    this.websocket.onmessage = async (msg) => {
      await this.getExploitsData();
      await this.getTeamsData();
      await this.getExploitStatus();

      this.timer = setInterval(async () => {
          await this.getFlagsTick();
          await this.getFlagsAccepted();
          await this.getFlagsAcceptedPerExploit();
      }, 30 * 1000);
    };
  },
  async unmounted() {
    this.websocket.close();
    clearInterval(this.timer);
  },
};
</script>
