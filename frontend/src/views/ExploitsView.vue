<template>
    <div class="container mt-4">
        <h1>Exploits</h1>
        <button @click="addExploit" class="btn btn-success mt-3 w-100" role="button">
            <i class="bi-plus-lg"></i> Add Exploit
        </button>
        <ExploitCard class="my-3" v-if="exploits" v-for="exploit in exploits" :prop-exploit="exploit" />
    </div>
</template>

<script>
import * as _ from "lodash";
import settings_json from '@/settings.json';
import { api } from "@/utils";
import ExploitCard from "@/components/ExploitCard.vue";

export default {
    name: 'Exploits',
    components: { ExploitCard },
    data() {
        return {
            exploits: [{
                "name": "string",
                "threads": 0,
                "timeout": 0,
                "runperiod": 0,
                "source": "string",
                "id": 0
            }],
            websocket: null
        };
    },
    methods: {
        async getExploitsData() {
            let exploits = await (await api.get('/exploits')).json();
            let exploitState = await (await api.get('/exploits/state')).json();

            this.exploits = _.merge(_.keyBy(exploits, 'id'), _.keyBy(exploitState, 'id'));
        },
        async addExploit(){
            await api.post('/exploits', {
                "name": "New Exploit",
                "threads": 8,
                "timeout": 60,
                "runperiod": 30,
                "source": ""
            });
            this.getExploitsData();
        },
    },
    async mounted() {
        await this.getExploitsData();

        this.websocket = new WebSocket(settings_json.ws)
        console.log(settings_json.ws)

        this.websocket.onmessage = async () => {
            await this.getExploitsData();
        }
    },
    async unmounted() {
        this.websocket.close()
    },
}
</script>
