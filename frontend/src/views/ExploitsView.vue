<template>
    <div class="container mt-4">
        <h1>Exploits</h1>
        <button class="btn btn-success mt-3 w-100" role="button" data-bs-toggle="modal" data-bs-target="#newExploit">
            <i class="bi-plus-lg"></i> Add Exploit
        </button>
        <ExploitModal
            prop-center
            prop-id="newExploit"
            prop-title="Exploit Creation"
            :prop-yep-func="addExploit"
            prop-yep-text="Create"
            prop-nop-text="Cancel"
            >
            <div class="input-group mb-3">
                <span class="input-group-text" style="width: 19%">Name</span>
                <input v-model="newExploitName" type="text" class="form-control" placeholder="MEANINGFUL NAME">
            </div>
            <div class="input-group mb-3">
                <span class="input-group-text" style="width: 19%">Service</span>
                <select v-model="newExploitServiceIndex" class="form-select">
                    <option v-for="(service, index) in services" :value="index">{{ service }}</option>
                </select>
            </div>
            <div class="input-group mb-3">
                <span class="input-group-text" style="width: 19%">Template</span>
                <select v-model="newExploitTemplateIndex" class="form-select">
                    <option v-for="(template, index) in templates" :value="index">{{ template.name }}</option>
                </select>
            </div>
        </ExploitModal>
        <ExploitCard class="my-3" v-if="exploits" v-for="exploit in exploits" :prop-exploit="exploit" />
    </div>
</template>

<script>
import * as _ from "lodash";
import settings from '@/settings.js';
import { api } from "@/utils";
import router from "@/router";
import ExploitCard from "@/components/ExploitCard.vue";
import ExploitModal from "@/components/ExploitModal.vue";

export default {
    name: 'Exploits',
    components: { ExploitCard, ExploitModal },
    data() {
        return {
            exploits: [/*{
                "name": "test",
                "threads": 0,
                "timeout": 0,
                "runperiod": 0,
                "source": "test",
                "id": 0
            }*/],
            newExploitName: "",
            newExploitTemplateIndex: 0,
            newExploitServiceIndex: 0,
            templates: settings.templates,
            services: settings.services,
            websocket: null
        };
    },
    methods: {
        async getExploitsData() {
            let exploits = await (await api.get('/exploits')).json();
            let exploitState = await (await api.get('/exploits/state')).json();

            this.exploits = _.merge(_.keyBy(exploits, 'id'), _.keyBy(exploitState, 'id'));
        },
        async addExploit(){
            const template = settings.templates[this.newExploitTemplateIndex];

            console.log(template);

            let id = await api.post('/exploits', {
                "name": this.newExploitName,
                "source": btoa(template.source),
                "threads": 8,
                "timeout": 60,
                "runperiod": 30,
            });

            id = parseInt(await id.text());
            router.push({ name: 'exploit-edit', params: { id } });
        },
    },
    async mounted() {
        await this.getExploitsData();

        this.websocket = new WebSocket(settings.websocket_url)
        console.log(settings.websocket_url)

        this.websocket.onmessage = async () => {
            await this.getExploitsData();
        }
    },
    async unmounted() {
        this.websocket.close()
    },
}
</script>
