<template>
    <div class="container my-4">
        <div v-if="loadPage" class="row">

            <!-- EXPLOIT -->
            <div class="col-8">

                <h3>Edit Exploit</h3>

                <div class="d-flex justify-content-between mt-3">
                    <div class="input-group">
                        <span class="input-group-text" id="basic-addon1">Name&nbsp&nbsp&nbsp</span>
                        <input v-model="exploit.name" class="form-control" type="text" placeholder="Exploit 0">
                    </div>
                    <div class="d-flex align-self-center">
                        <button @click="downloadExploit" title="Download" type="button" class="btn btn-outline-primary ms-2">
                            <i class="bi bi-file-earmark-arrow-down-fill"></i>
                        </button>
                        <button @click="saveExploit" title="Save" type="button" class="btn btn-outline-primary ms-2">
                            <!-- <font-awesome-icon :icon="['fas', 'floppy-disk']" style="color: #474d57;" /> -->
                            <i class="bi bi-file-earmark-arrow-up-fill"></i>
                        </button>
                        <button @click="deleteExploit" title="Delete" type="button" class="btn btn-outline-danger ms-2">
                            <i class="bi bi-trash-fill"></i>
                        </button>
                    </div>
                </div>

                <div class="d-flex" style="gap:10px">
                    <div class="input-group mt-2">
                        <span class="input-group-text" id="basic-addon1">Threads</span>
                        <input v-model="exploit.threads" type="number" class="form-control" placeholder="8">
                    </div>
                    <div class="input-group mt-2">
                        <span title="(seconds)" class="input-group-text" id="basic-addon1">Timeout</span>
                        <input v-model="exploit.timeout" type="number" class="form-control" placeholder="60">
                    </div>
                    <div class="input-group mt-2">
                        <span title="time before next execution (seconds)" class="input-group-text" id="basic-addon1">Runperiod</span>
                        <input v-model="exploit.runperiod" type="number" class="form-control" placeholder="30">
                    </div>
                </div>

                <textarea v-model="exploit.source" class="form-control mt-2" style="resize: none; height: 65vh;"></textarea>

            </div>

            <!-- TEAMS -->
            <div v-if="teams.length" class="col-4">

                <h3>Teams</h3>

                <div class="btn-group w-100 mt-3" role="group" aria-label="Basic example">
                    <button @click="selectAllTeams" type="button" class="btn btn-outline-secondary">Select All</button>
                    <button @click="deselectAllTeams" type="button" class="btn btn-outline-secondary">Deselect All</button>
                </div>

                <ul class="list-group border mt-2" style="height: 74.8vh; overflow-y: scroll;">
                    <TeamCard v-for="team in teams" 
                        :prop-team="team" 
                        :prop-selected="selectedTeams.includes(team.id)" 
                        :prop-on-click="() => toggleSelectedTeam(team.id)"/>
                </ul>

            </div>
            <div v-else class="col-4">
                <h4>No team found</h4>
            </div>
        </div>
        <div v-else>
            <h4>Exploit not found</h4>
        </div>
    </div>
</template>

<script>
import { api } from '../utils';
import TeamCard from '../components/TeamCard.vue';

export default {
    name: 'Exploit details',
    components: { TeamCard },
    data() {
        return {
            loadPage: false,
            exploit: {},
            teams: [],
            selectedTeams: [],
            stop: true,
        };
    },
    methods: {
        async getTeams() {
            this.teams = await (await api.get('/teams')).json();
        },
        async getSelectedTeams() {
            this.selectedTeams = await (await api.get(`/exploits/${this.$route.params.id}/teams`)).json();
        },
        async getExploit() {
            let res = await api.get(`/exploits/${this.$route.params.id}`);
            if (res.status !== 200) {
                this.loadPage = false;
                return;
            };
            this.loadPage = true;
            let tempExploit = await res.json();
            tempExploit.source = atob(tempExploit.source);
            this.exploit = tempExploit;
        },
        saveExploit() {
            let tempExploit = JSON.parse(JSON.stringify(this.exploit));
            tempExploit.source = btoa(tempExploit.source)
            api.patch(`/exploits/${this.$route.params.id}`, tempExploit);
            api.patch(`/exploits/${this.$route.params.id}/teams`, {"ids": this.selectedTeams});
        },
        downloadExploit() {
            const blob = new Blob([this.exploit.source], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = this.exploit.name;
            link.click();
            URL.revokeObjectURL(link.href);
        },
        async deleteExploit() {
            await api.delete(`/exploits/${this.$route.params.id}`);
            this.getExploit();
        },
        selectAllTeams() {
            this.selectedTeams = Array(this.teams.length).fill(null).map((u, i) => i+1);
        },
        deselectAllTeams() {
            this.selectedTeams = [];
        },
        toggleSelectedTeam(id) {
            if (this.selectedTeams.includes(id)) {
                // remove id from array
                this.selectedTeams.forEach((value, index) => {
                    if (value === id) {
                        this.selectedTeams.splice(index, 1);
                    }
                });
            }
            else {
                console.log(id)
                this.selectedTeams.push(id);
            }
        },
        
    },
    async mounted() {
        await this.getExploit();
        await this.getTeams();
        await this.getSelectedTeams();
    },
}
</script>