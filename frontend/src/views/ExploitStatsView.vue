<template>
    <div class="container d-flex flex-column" style="height: calc(100vh - 58px - 4.5rem)">
        <div v-if="loadPage" class="d-flex flex-column" style="flex: 1; min-height: 100%">
            <h3>Exploit Stats ({{ exploit.name }})</h3>
            <div class="row mt-4" style="flex: 1">
                <select class="form-select" aria-label="Default select example">
                    <option value="0">All</option>

                </select>
                <div class="flex-fill mt-4">
                    <Line v-if="flagsTick" :data="flagsTick" :options="flagsTickOptions" />
                </div>
            </div>
        </div>
        <div v-else>
            <h3>No data available</h3>
        </div>
    </div>
</template>

<script>
"use strict";

import * as _ from "lodash";
import { api, colors } from "../utils.js";
import {
    Chart as ChartJS,
    CategoryScale,
    LinearScale,
    PointElement,
    LineElement,
    Title,
    Tooltip,
    Legend,
    ArcElement,
    BarElement,
} from "chart.js";
import { Line, Pie, Bar } from "vue-chartjs";

ChartJS.register(
    CategoryScale,
    LinearScale,
    PointElement,
    LineElement,
    Title,
    ArcElement,
    BarElement,
    Tooltip,
    Legend
);

export default {
    name: "Dashboard",
    components: { Line, Pie, Bar },
    data() {
        return {
            loadPage: false,
            exploit: undefined,
            timer: undefined,
            flagsTick: undefined,
            flagsAccepted: undefined,
            flagsAcceptedPerExploit: undefined,
            teams: undefined,
            flagsTickOptions: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Month'
                        }
                    },
                    y: {
                        stacked: true,
                        title: {
                            display: true,
                            text: 'Value'
                        }
                    }
                },
            },
            flagsAcceptedOptions: {
                responsive: true,
                maintainAspectRatio: false,
            },
        };
    },
    methods: {
        async getExploit() {
            try {
                let req = await api.get(`/exploits/${this.$route.params.id}`);
                if (req.status === 200) {
                    this.exploit = await req.json();
                    this.loadPage = true;
                }
            } catch (exception) {
                console.log(exception);
            }
        },
        async getFlagsTick() {
            let res = {};
            try {
                let req = await api.get(`/stats/flags/exploit/${this.$route.params.id}/teams`);
                if (req.status === 200) {
                    res = await req.json();
                }
            } catch (exception) {
                console.log(exception);
            }

            console.log(res)

            console.log(Object.keys(res).map(el => {
                return res[el][2]
            }))

            let teamids = Object.keys(res[Object.keys(res)[0]])

            console.log(teamids)

            let out = [];

            let labels = Object.keys(res).reverse().map((el) => {
                return new Date(new Date(el * 1000).toUTCString())
                    .toLocaleString()
                    .split(", ")[1]
                    .slice(0, -3);
            });

            console.log(labels)

            /*

            [
                    {
                        label: "Flags",
                        data: out.map(item => item.total),
                        fill: true,
                        backgroundColor: "#fd7e14",
                        borderColor: "#fd7e14",
                    },
                ]

            */

            this.flagsTick = {
                labels,
                datasets: [{
                    label: "Flags",
                    data: Object.keys(res).map(item => Object.keys(res[item]).reduce((acc, el) => parseInt(acc) + res[item][el])),
                    fill: true,
                    backgroundColor: "#fd7e14",
                    borderColor: "#fd7e14",
                }],
            };
        },
        async getFlagsAccepted() {
            let res = {
                queued: 0, accepted: 0, rejected: 0
            };
            try {
                let req = await api.get(`/stats/flags/script/${this.$route.params.id}/all`);

                if (req.status !== 200) {
                    res = await req.json();
                }
            } catch (exception) {
                console.log(exception);
            }
            console.log(res);

            this.flagsAccepted = {
                labels: ["Queued", "Accepted", "Rejected"],
                datasets: [
                    {
                        data: [res.queued, res.accepted, res.rejected],
                        backgroundColor: colors.green1,
                        backgroundColor: ["#a7acb1", "#198754", "#dc3545"],
                    },
                ],
            };
        },
        async getDetailed() {
            let req = await api.get(`/stats/flags/exploit/${this.$route.params.id}/teams`);
            console.log(req)

            let res = await req.json()
            console.log(res)
        },
    },
    async mounted() {
        this.teams = await api.get(`/exploits/${this.$route.params.id}/reams`)


        await this.getExploit();
        await this.getFlagsTick();
        await this.getFlagsAccepted();
        //await this.getDetailed();

        this.timer = setInterval(async () => {
            await this.getFlagsTick();
            await this.getFlagsAccepted();
        }, 30 * 1000);
    },
    async unmounted() {
        clearInterval(this.timer);
    },
};
</script>
