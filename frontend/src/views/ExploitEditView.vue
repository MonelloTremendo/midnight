<template>
    <div class="container d-flex" style="flex-direction: column; height: calc(100vh - 58px - 4.5rem);">
        <div v-if="loadPage" class="row" style="flex: 0 1 auto; min-height: 100%;">

            <!-- EXPLOIT -->
            <div class="col-8 d-flex" style="flex-direction: column;">

                <h3>Edit Exploit</h3>

                <div class="d-flex justify-content-between mt-3">
                    <div class="input-group">
                        <span class="input-group-text" id="basic-addon1">Name&nbsp&nbsp&nbsp</span>
                        <input v-model="exploit.name" class="form-control" type="text">
                    </div>
                    <div class="d-flex align-self-center">
                        <button @click="stopExploit"  class="size38x38 btn btn-outline-danger ms-2" v-if="status">
                            <i class="h4 bi-stop-fill"></i>
                        </button>
                        <button @click="startExploit" class="size38x38 btn btn-outline-success ms-2" v-else>
                            <i class="h4 bi-play-fill"></i>
                        </button>
                        <button @click="downloadExploit" title="Download" type="button" class="size38x38 btn btn-outline-primary ms-2">
                            <i class="bi bi-file-earmark-arrow-down-fill"></i>
                        </button>
                        <button @click="saveExploit" title="Save" type="button" class="size38x38 btn btn-outline-primary ms-2">
                            <!-- <font-awesome-icon :icon="['fas', 'floppy-disk']" style="color: #474d57;" /> -->
                            <i class="bi bi-file-earmark-arrow-up-fill"></i>
                        </button>
                        <button @click="deleteExploit" title="Delete" type="button" class="size38x38 btn btn-outline-danger ms-2">
                            <i class="bi bi-trash-fill"></i>
                        </button>
                    </div>
                </div>

                <div class="d-flex" style="gap:10px">
                    <div class="input-group mt-2">
                        <span class="input-group-text" id="basic-addon1">Threads</span>
                        <input v-model="exploit.threads" type="number" class="form-control" placeholder="8">
                    </div>
                    <div class="input-group mt-2">
                        <span title="(seconds)" class="input-group-text" id="basic-addon1">Timeout</span>
                        <input v-model="exploit.timeout" type="number" class="form-control" placeholder="60">
                    </div>
                    <div class="input-group mt-2">
                        <span title="time before next execution (seconds)" class="input-group-text" id="basic-addon1">Runperiod</span>
                        <input v-model="exploit.runperiod" type="number" class="form-control" placeholder="30">
                    </div>
                </div>

                <CodeEditor 
                    v-model="exploit.source" 
                    theme="panda-syntax-dark" 
                    :languages="[['python', 'Python']]"
                    width="100%" 
                    height="65vh" 
                    class="mt-3"
                    style="flex: 1;"/>
                
            </div>

            <!-- TEAMS -->
            <div v-if="teams.length" class="col-4 d-flex" style="flex-direction: column;">

                <h3>Teams</h3>

                <div class="btn-group w-100 mt-3" role="group" aria-label="Basic example">
                    <button @click="selectAllTeams" type="button" class="btn btn-outline-secondary">Select All</button>
                    <button @click="deselectAllTeams" type="button" class="btn btn-outline-secondary">Deselect All</button>
                </div>

                <ul class="list-group border mt-2" style="flex: 1; overflow-y: scroll;">
                    <TeamCard v-for="team in teams" 
                        :prop-team="team" 
                        :prop-selected="selectedTeams.includes(team.id)" 
                        :prop-on-click="() => toggleSelectedTeam(team.id)"/>
                </ul>

            </div>
            <div v-else class="col-4">
                <h4>No team found</h4>
            </div>
        </div>
        <div v-else>
            <h4>Exploit not found</h4>
        </div>
    </div>
</template>

<style scoped>
.size38x38 {
    width: 38px;
    height: 38px;
    padding: 0;
}
</style>

<script>
import { api } from '@/utils';
import settings from '@/settings.js';
import TeamCard from '@/components/TeamCard.vue';
import CodeEditor from "simple-code-editor";



export default {
    name: 'Exploit Edit',
    components: { TeamCard, CodeEditor },
    data() {
        return {
            loadPage: true,
            status: undefined,
            exploit: {},
            teams: [],
            selectedTeams: [],
            websocket: null
        };
    },
    methods: {
        async getTeams() {
            this.teams = await (await api.get('/teams')).json();
        },
        async getSelectedTeams() {
            this.selectedTeams = await (await api.get(`/exploits/${this.$route.params.id}/teams`)).json();
        },
        async getExploit() {
            let res = await api.get(`/exploits/${this.$route.params.id}`);
            if (res.status !== 200) {
                this.loadPage = false;
                return;
            };
            this.loadPage = true;
            let tempExploit = await res.json();
            tempExploit.source = atob(tempExploit.source);
            this.exploit = tempExploit;
        },
        async getExploitStatus() {
            this.status = parseInt(await (await api.get(`/exploits/${this.exploit.id}/state`)).text());
        },
        async startExploit(){
            await api.put(`/exploits/${this.exploit.id}/state?status=1`);
            this.status = 1;
        },
        async stopExploit(){
            await api.put(`/exploits/${this.exploit.id}/state?status=0`);
            this.status = 0;
        },
        saveExploit() {
            let tempExploit = JSON.parse(JSON.stringify(this.exploit));
            tempExploit.source = btoa(tempExploit.source)
            api.patch(`/exploits/${this.$route.params.id}`, tempExploit);
            api.patch(`/exploits/${this.$route.params.id}/teams`, {"ids": this.selectedTeams});
        },
        downloadExploit() {
            const blob = new Blob([this.exploit.source], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = this.exploit.name;
            link.click();
            URL.revokeObjectURL(link.href);
        },
        async deleteExploit() {
            if(window.confirm("Are you sure about that?")){
                await api.delete(`/exploits/${this.$route.params.id}`);
                this.getExploit();
            }
        },
        selectAllTeams() {
            this.selectedTeams = this.teams.map((item) => item.id);
        },
        deselectAllTeams() {
            this.selectedTeams = [];
        },
        toggleSelectedTeam(id) {
            if (this.selectedTeams.includes(id)) {
                // remove id from array
                this.selectedTeams.forEach((value, index) => {
                    if (value === id) {
                        this.selectedTeams.splice(index, 1);
                    }
                });
            }
            else {
                this.selectedTeams.push(id);
            }
        },
        
    },
    async mounted() {
        await this.getExploit();
        await this.getTeams();
        await this.getSelectedTeams();
        await this.getExploitStatus();

        this.websocket = new WebSocket(settings.websocket_url)
        this.websocket.onmessage = async () => {
            await this.getExploit();
            await this.getTeams();
            await this.getSelectedTeams();
            await this.getExploitStatus();
        }
    },
    async unmounted() {
        this.websocket.close()
    },
}
</script>

