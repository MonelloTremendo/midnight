<template>
  <div
    class="card"
    style="height: 75px"
    :class="{
      // 'border border-2 border-success': logStatus === logStatusEnum.normal,
      'border border-2 border-danger': logStatus === logStatusEnum.danger,
      'border border-2 border-warning': logStatus === logStatusEnum.warning,
    }"
  >
    <div class="card-body py-0 px-3 d-flex align-items-center">
      <div class="d-flex justify-content-between align-items-center w-100">
        <!-- EXPLOIT NAME -->
        <h4 class="m-0">{{ propExploit.name }}</h4>

        <div class="d-flex" style="gap: 10px">
          <!-- TAGS LIST -->
          <div
            class="me-2 d-flex justify-content-start align-items-end"
            style="gap: 6px"
          >
            <small
              class="text-light rounded-pill text-center m-0 px-2"
              :class="{
                'bg-secondary': selectedTeamsStatus === logStatusEnum.normal,
                'bg-warning text-dark': selectedTeamsStatus === logStatusEnum.warning,
                'bg-danger': selectedTeamsStatus === logStatusEnum.danger,
              }"
              style="width: 100px"
            >
              teams: {{ propSelectedTeams.length }}
            </small>
            <small
              v-if="propFlagsCount !== undefined"
              class="text-light rounded-pill text-center m-0 px-2"
              :class="{
                'bg-secondary': flagsStatus === logStatusEnum.normal,
                'bg-warning text-dark': flagsStatus === logStatusEnum.warning,
                'bg-danger': flagsStatus === logStatusEnum.danger,
              }"
              style="width: 150px"
            >
              flags last round: {{ propFlagsCount }}
            </small>
          </div>

          <!-- BUTTONS -->
          <button
            @click="loadEditPage"
            class="size44x44 btn btn-primary"
            role="button"
          >
            <i class="m-0 h5 bi-pencil-fill"></i>
          </button>
          <button
            @click="loadStatsPage"
            class="size44x44 btn btn-primary"
            role="button"
          >
            <i class="m-0 h5 bi-bar-chart-line-fill"></i>
          </button>
          <button
            v-if="propExploit.status"
            @click="stopExploit"
            class="size44x44 btn btn-danger"
            role="button"
          >
            <i class="m-0 h4 bi-stop-fill"></i>
          </button>
          <button
            v-else
            @click="startExploit"
            class="size44x44 btn btn-success"
            role="button"
          >
            <i class="m-0 h4 bi-play-fill"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

<style scoped>
.size44x44 {
  width: 44px;
  height: 44px;
  padding: 0;
  display: flex;
  justify-content: center;
  align-items: center;
}

.traslate {
  transform: translateY(0.15px);
}
</style>

<script>
import { api } from "../utils.js";

const FLAG_WARNING_LIMIT = 20;
const logStatusEnum = {
  off: -1,
  normal: 0,
  warning: 1,
  danger: 2,
};

export default {
  name: "ExploitCard",
  data() {
    return {
      logStatusEnum,
      logStatus: logStatusEnum.normal,
      selectedTeamsStatus: logStatusEnum.normal,
      flagsStatus: logStatusEnum.normal
    };
  },
  props: ["propExploit", "propFlagsCount", "propSelectedTeams"],
  methods: {
    loadEditPage() {
      this.$router.push({
        name: "exploit-edit",
        params: { id: this.propExploit.id },
      });
    },
    loadStatsPage() {
      this.$router.push({
        name: "exploit-stats",
        params: { id: this.propExploit.id },
      });
    },
    async startExploit() {
      await api.put(`/exploits/${this.propExploit.id}/state?status=1`);
      this.propExploit.status = 1;
      this.updateWarning();
    },
    async stopExploit() {
      await api.put(`/exploits/${this.propExploit.id}/state?status=0`);
      this.propExploit.status = 0;
      this.updateWarning();
    },
    updateWarning() {
      if (this.propExploit.status === 1) 
      {
        if (this.propFlagsCount === 0) {
          this.flagsStatus = logStatusEnum.danger;
        } else if (this.propFlagsCount < FLAG_WARNING_LIMIT) {
          this.flagsStatus = logStatusEnum.warning;
        }

        if (this.propSelectedTeams.length === 0) {
          this.selectedTeamsStatus = logStatusEnum.danger;
        }
        this.logStatus = Math.max(this.selectedTeamsStatus, this.flagsStatus);
      } else {
        this.flagsStatus = logStatusEnum.normal;
        this.selectedTeamsStatus = logStatusEnum.normal;
        this.logStatus = logStatusEnum.off;
      }
      
    },
  },
  async mounted() {
    await this.updateWarning();
  },
};
</script>
