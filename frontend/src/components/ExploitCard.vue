<template>
  <div
    class="card"
    style="height: 75px"
    :class="{
      // 'border border-2 border-success': status === StatusEnum.normal,
      'border border-2 border-danger': status === StatusEnum.danger && propExploit.status,
      'border border-2 border-warning': status === StatusEnum.warning && propExploit.status,
    }"  >
    <div class="card-body py-0 px-3 d-flex align-items-center">
      <div class="d-flex justify-content-between align-items-center w-100">
        <!-- EXPLOIT NAME -->
        <h4 class="m-0">{{ propExploit.name }}</h4>

        <div class="d-flex" style="gap: 0.5rem">
          <!-- TAGS LIST -->
          <div v-if="propExploit.status" class="me-2 mr-2 d-flex my-auto" @click="alertExploitedTeams" style="gap: .5rem;">
            <span
              v-if="exploitingTeamsStatus !== undefined && exploitedTeams !== undefined"
              :role="exploitingTeamsStatus >= StatusEnum.warning ? 'button' : ''"
              style="min-width: 7.5rem;"
              class="text-light badge text-center"
              :class="{
                'bg-secondary': exploitingTeamsStatus === StatusEnum.off,
                'bg-warning text-dark': exploitingTeamsStatus === StatusEnum.warning,
                'bg-danger': exploitingTeamsStatus === StatusEnum.danger,
              }">
              Exploiting: {{ exploitedTeams.length }} / {{ propSelectedTeams.length }}
            </span>
            <span
              v-if="propSelectedTeams !== undefined && propTeams !== undefined"
              style="min-width: 7.5rem;"
              class="text-light badge text-center"
              :class="{
                'bg-secondary': selectedTeamsStatus === StatusEnum.off,
                'bg-warning text-dark': selectedTeamsStatus === StatusEnum.warning,
                'bg-danger': selectedTeamsStatus === StatusEnum.danger,
              }">
              Selected: {{ propSelectedTeams.length }} / {{ propTeams.length }}
            </span>
            <span
              v-if="propFlagsCount"
              style="min-width: 6rem;"
              class="text-light badge text-center"
              :class="{
                'bg-secondary': flagsStatus === StatusEnum.off,
                'bg-warning text-dark': flagsStatus === StatusEnum.warning,
                'bg-danger': flagsStatus === StatusEnum.danger,
              }">
              Tick Flags: {{ propFlagsCount.flags }}
            </span>
          </div>

          <!-- BUTTONS -->
          <button
            @click="loadEditPage"
            class="size44x44 btn btn-primary"
            role="button"
          >
            <i class="m-0 h5 bi-pencil-fill"></i>
          </button>
          <button
            @click="loadStatsPage"
            class="size44x44 btn btn-primary"
            role="button"
          >
            <i class="m-0 h5 bi-bar-chart-line-fill"></i>
          </button>
          <!--
          <button
            @click="loadTeamsPage"
            class="size44x44 btn btn-primary"
            role="button">
            <i class="m-0 h5 bi-people-fill"></i>
          </button>
          -->
          <button
            v-if="propExploit.status"
            @click="stopExploit"
            class="size44x44 btn btn-danger"
            role="button"
          >
            <i class="m-0 h4 bi-stop-fill"></i>
          </button>
          <button
            v-else
            @click="startExploit"
            class="size44x44 btn btn-success"
            role="button"
          >
            <i class="m-0 h4 bi-play-fill"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

<style scoped>
.size44x44 {
  width: 44px;
  height: 44px;
  padding: 0;
  display: flex;
  justify-content: center;
  align-items: center;
}

</style>

<script>
import { api } from "../utils.js";
import Modal from "./Modal.vue";
import settings from "../settings";

const StatusEnum = {
  off: -1,
  normal: 0,
  warning: 1,
  danger: 2,
};

export default {
    name: "ExploitCard",
    components: { Modal },
    data() {
        return {
            //TODO maybe da passare come parametro
            exploitedTeams: undefined,
            StatusEnum,
            status: StatusEnum.off,
            selectedTeamsStatus: StatusEnum.off,
            exploitingTeamsStatus: StatusEnum.off,
            flagsStatus: StatusEnum.off
        };
    },
    watch: {
      propExploit: {
        // the callback will be called immediately after the start of the observation
        immediate: true, 
        handler (val, oldVal) {
          this.updateWarning();  
        }
      }
    },
    props: ["propExploit", "propFlagsCount", "propSelectedTeams", "propTeams"],
    methods: {
        loadEditPage() {
          this.$router.push({
              name: "exploit-edit",
              params: { id: this.propExploit.id },
          });
        },
        loadStatsPage() {
          this.$router.push({
              name: "exploit-stats",
              params: { id: this.propExploit.id },
          });
        },
        loadTeamsPage() {
              this.$router.push({
              name: "exploit-teams",
              params: { id: this.propExploit.id },
          });
        },
        async startExploit() {
            await api.put(`/exploits/${this.propExploit.id}/state?status=1`);
            this.propExploit.status = 1;
        },
        async stopExploit() {
            await api.put(`/exploits/${this.propExploit.id}/state?status=0`);
            this.propExploit.status = 0;
        },
        async getExploitedTeams() {
            let req = await api.get(`/stats/flags/script/${this.propExploit.id}/teams`);
            if (req.status !== 200) {
                this.exploitedTeams = [];
                return;
            };
            let res = await req.json();
            this.exploitedTeams = res;
        },  
        alertExploitedTeams() {
            if (this.exploitingTeamsStatus < StatusEnum.warning) return;
            // create a list of all the teamsId of not exploited teams
            const notExploitedTeams = this.propSelectedTeams.filter(
                el => !this.exploitedTeams.find(
                    explTeam => explTeam.team === el
                )
            )
            //console.log('notExploitedTeams', notExploitedTeams)
            //console.log('propTeams', this.propTeams)

            const MSG_HEADER = "NOT EXPLOITED TEAMS (if too long check the console)\n";
            let text = '';
            notExploitedTeams.forEach(teamId => {
                text += this.propTeams.find(team => team.id === teamId).name;
                text += '\n';
            });
            console.clear()
            console.group('NOT EXPLOITED TEAMS')
            console.log(text)
            console.groupEnd()
            alert(MSG_HEADER + "" + text);
        },
        async updateWarning() {
            if (this.propFlagsCount.flags === 0) {
                this.flagsStatus = StatusEnum.danger;
            } else if (this.propFlagsCount.flags < settings.FLAG_WARNING_LIMIT) {
                this.flagsStatus = StatusEnum.warning;
            } else {
                this.flagsStatus = StatusEnum.off;
            }

            if (this.propSelectedTeams.length === 0) {
                this.selectedTeamsStatus = StatusEnum.danger;
            } else {
                this.selectedTeamsStatus = StatusEnum.off;
            }

            // flags retrieved per team in last tick
            let res = await api.get(`/stats/flags/script/${this.propExploit.id}/teams`);
            if (res.status === 200) {
                res = await res.json();
                if (res.length < this.propSelectedTeams.length * settings.TEAMS_WARNING_LIMIT) {
                    this.exploitingTeamsStatus = StatusEnum.warning;
                }
                // for the MEME
                else if (res.length === 0) {
                    this.exploitingTeamsStatus = StatusEnum.danger;
                }
            } else {
                this.exploitingTeamsStatus = StatusEnum.off;
            }

            this.status = Math.max(this.selectedTeamsStatus, this.flagsStatus, this.exploitingTeamsStatus);
        },
    },
    mounted() {
        this.getExploitedTeams()
        this.updateWarning();
    },
};
</script>
